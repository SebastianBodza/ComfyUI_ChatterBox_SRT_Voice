# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ComfyUI ChatterBox SRT Voice (v2.0.2) is a sophisticated ComfyUI custom node extension providing high-quality Text-to-Speech (TTS) and Voice Conversion capabilities. This is a refactored version of the original ChatterBox Voice with enhanced SRT timing support and F5-TTS integration.

## Core Architecture

- **ComfyUI Custom Node Extension**: Integrates with ComfyUI's node system
- **Modular Design**: Clean separation between core functionality, nodes, and ChatterBox package
- **Graceful Degradation**: Conditional feature loading based on available dependencies
- **Plugin-Based**: Self-contained with bundled models support

## Key Directories

- `core/`: Core functionality (model_manager, import_manager, audio_processing, text_chunking)
- `nodes/`: Node implementations extending `base_node.py`
- `chatterbox/`: ChatterBox TTS/VC implementation and models
- `srt/`: SRT timing engine and audio assembly
- `web/`: JavaScript UI components for voice capture and controls

## Main Entry Points

- `__init__.py`: Primary ComfyUI entry point, registers all nodes
- `nodes.py`: Node loading and management with import fallbacks
- `nodes/base_node.py`: Base class for all node implementations

## Architecture Patterns

### Import Management

- Uses `core/import_manager.py` for complex dependency handling
- Graceful fallbacks for missing optional dependencies
- Conditional feature loading based on available packages

### Model Loading

- Centralized model management via `core/model_manager.py`
- Priority-based loading: bundled → ComfyUI models → HuggingFace
- Caching and memory optimization

### Node Structure

- All nodes extend `nodes/base_node.py`
- Consistent error handling and logging
- Modular functionality with clear separation of concerns

### Text Processing

- Intelligent chunking via `core/text_chunking.py`
- Sentence boundary preservation
- Multiple combination methods (auto, concatenate, silence_padding, crossfade)

## Key Features

### TTS Capabilities

- ChatterBox TTS with unlimited text length
- F5-TTS voice synthesis with reference audio
- Multi-language support (English, German, Spanish, French, Japanese)
- Smart text chunking for long content

### SRT Integration

- SRT timing-synchronized TTS generation
- Smart timing modes with flexible shifting logic
- Segment-level caching for efficiency

### Audio Processing

- Voice capture with silence detection
- Voice conversion between speakers
- Audio analysis and format support

### Audio Analyzer Node

- Interactive waveform visualization with real-time analysis
- Connected audio input support with priority over file paths
- Multiple input scenarios: file-only, connected-only, or both (connected takes priority)
- Real-time audio playback synchronized with waveform visualization
- Automatic temporary file generation for web-accessible connected audio playback

## Dependencies

Core dependencies (from pyproject.toml):

- `transformers==4.46.3` (version pinned for compatibility)
- `s3tokenizer>=0.1.7`
- `resemble-perth`
- `librosa`, `scipy`, `omegaconf`, `accelerate`
- `torch`, `torchaudio`, `numpy`, `einops`
- `conformer>=0.3.2`, `phonemizer`, `g2p-en`
- `soundfile`, `resampy`, `webrtcvad`

## Development Notes

- No formal linting/testing commands configured
- Manual testing via ComfyUI interface
- Focus on backward compatibility and graceful degradation
- User don't want any testing file to be created, he will test it on ComfyUI by LLM request

## Successful Approaches & Key Learning

#### Debugging Lessons

- Keep debug logs until ALL scenarios work, then clean up
- Method context issues can cause subtle data transformation bugs
- Audio playback requires web-accessible URLs, not local file paths

# 